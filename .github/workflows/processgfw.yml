name: Convert gfw.list

on:
  schedule:
    - cron: '0 */3 * * *'
  push:
    branches: [ main ]
    paths:
      - "rule/gfw-raw.list"
  workflow_dispatch:

jobs:
  convert_domains:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Download GFW List
      run: |
        curl -fsSL -o rule/gfwlist.txt https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt
        echo "Downloaded gfwlist.txt"

    - name: Decode and save to gfw-raw.list
      run: |
        base64 -d rule/gfwlist.txt > rule/gfw-raw.list
        echo "Decoded and saved to gfw-raw.list"

    - name: Process domain file
      run: |
        echo "Processing domain file..."
        original_file=rule/gfw-raw.list
        converted_file=rule/gfw.list
        
        if [ -f "$converted_file" ]; then
          rm "$converted_file"
        fi
        
        while IFS= read -r line; do
          if [[ "$line" == "@@"* || "$line" == "!"* ]]; then
            continue
          elif [[ "$line" =~ ^\|https?:// ]]; then
            domain=$(echo "$line" | sed -E 's/^\|https?:\/\/([^/]+).*$/\1/')
            echo "Processed DOMAIN-SUFFIX, $domain"
            echo "DOMAIN-SUFFIX,$domain" >> "$converted_file" 
          elif [[ "$line" =~ ^\|\| ]]; then
            domain=$(echo "$line" | sed 's/^||//')
            echo "Processed DOMAIN, $domain"
            echo "DOMAIN,$domain" >> "$converted_file"
          elif [[ "$line" =~ ^\. ]]; then
            domain=$(echo "$line" | cut -c 2-)
            echo "Processed DOMAIN-SUFFIX, $domain"
            echo "DOMAIN-SUFFIX,$domain" >> "$converted_file"
          else
            if [[ "$line" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              echo "Processed IP-CIDR: $line"
              echo "IP-CIDR,$line/32" >> "$converted_file"
            else
              echo "Processed DOMAIN: $line"
              echo "DOMAIN,$line" >> "$converted_file"
            fi
          fi
        done < "$original_file"
        echo "Domain processing completed."

    - name: Stage changes
      run: |
        echo "Staging changes..."
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git add rule/gfw.list
        git status

    - name: Commit changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Update gfw.list
        branch: main
